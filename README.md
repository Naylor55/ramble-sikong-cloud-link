# ramble-sikong-cloud-link
大疆司空2平台云端互联对接

# 司空2概述
大疆司空 2 是一款无人机任务管理云平台，具备团队、标注信息、地图照片、作业区域、航线库、计划库、媒体库、模型库、人员设备管理与云端互联等功能。云平台支持多款机型作业，通过网页端进行航线规划，利用机场执行飞行任务，可远程获取实时作业信息，提高团队合作效率。

# 云端互联概述

云端互联功能提供大疆司空 2 与第三方云平台对接，进行设备直传、遥测数据、设备码流、模型后重建文件、航线文件同步与消息通知展示。

功能：

* 设备直传：飞行器作业过程中产生的媒体文件直接发送到第三方云平台储存桶进行储存
* 遥测数据：飞行参数通过mqtt协议对接到第三方运平台。例如：飞行过程中实时经纬度，飞机偏航角、俯仰角、横滚角，云台偏航角、俯仰角、横滚角，相对高度，绝对高度等等
* 直播转发：将直播画面转发到第三方流媒体服务器
* 航线文件：提供司空 2 和 云平台航线文件双向同步的功能
* 飞行任务：创建飞行计划、根据指定航线文件执行飞行计划
* 基础数据管理：组织数据、项目数据、设备数据管理
* WebHook：媒体文件上传通知，模型后重建/航线文件上传通知，上报航线任务执行进度，返航信息推送，退出返航通知

# 如何对接云端互联

简单来说分两个部分：
* 首先需要在司空2平台配置三方云平台的信息，包括：WebHook地址，设备直传url，遥测数据mqtt服务器，直播转发rtmp服务器。
* 调用云端互联RESTFul接口完成业务功能，这里先要从司空2获取“组织密钥”，即token，调用接口需要吧token放header中。

# 配置基本信息

需要使用组织管理员或超级管理员登录司空2平台，进入“我的组织”，点击“齿轮”进入组织设置页面，选择“添加云端互联服务”，填写基本信息。

* 组织密钥：组织密钥为调用当前组织云端互联 API 的身份凭证，组织密钥是司空2自动生成的，是JWT票据，在调用RESTFul接口的时候需要放到header中。
* 三方云名称：为调用云平台名称。
* Webhook URL：云端互联 API 交互对端地址，用于将当前组织信息通知传递给第三方云平台。
* 点击“确定”完成基本信息配置

> 这里有一个坑：默认的组织密钥不是 JWT 格式的，需要刷新一下才是。


# 配置设备直传

设备直传功能开启后，飞行器作业过程中产生的媒体文件将不通过司空 2，直接发送到第三方云平台储存桶进行储存。

1：完成基本信息配置。
2：点击“配置设备直传”，填写存储地址。
3：点击三个点 ---> “编辑” 可重新编辑配置信息，点击“删除”可删除配置信息，停止文件传输。

# 配置遥测数据

配置遥测数据能将机场与飞行器工作过程中的相关数据同步到第三方云平台。配置完成后，相关数据会立即同步到第三方云平台，数据内容与上云 API与物模型设备属性推送一致。

1：完成基本信息配置。
2：点击“配置遥测数据”，填写 MQTT Broker 信息。推送数据详见 大疆机场 MQTT 详情 与 飞行器 MQTT 详情。
3：点击 三个点 ---> “编辑” 可重新编辑配置信息，点击“删除”可删除配置信息，停止数据同步


# 配置直播转发

配置设备码流能将飞行器码流数据同步到第三方云平台。

1：完成基本信息配置。
2：点击“配置转发码流”，配置 RTMP Server 信息。
3：开启码流转发：调用 发起码流转发 接口，开启码流转发功能，码流数据即可推向第三方云平台服务器。
4：关闭码流转发：调用 获取码流转发频道转码器 接口，获得码流通道的 converter_id。调用 关闭码流转发 接口，配置 converter_id 内容，关闭码流转发功能。
5：点击三个点 ---> “编辑” 可重新编辑配置信息，点击“删除”可删除配置信息。


配置转发码流时需注意：

1：当前仅支持 RTMP 格式码流。
2：可通过调用 获取指定项目的设备列表 接口获取设备 SN。
3：完成码流转发后，需调用关闭码流转发接口，否则会持续扣除当前组织的直播分钟数。
4：若用户创建多个转码器转发同个直播镜头码流，会相应扣除各个转码器消耗的直播分钟数。



# 引用
* 司空2说明文档：https://fh.dji.com/user-manual/cn/overview.html
* 云端互联介绍：https://fh.dji.com/user-manual/cn/flighthub-sync/introduction.html